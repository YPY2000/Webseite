import React, { useEffect, useMemo, useRef, useState } from "react";

// ===== Helper Types =====
const GOALS = [
  { id: "essenWennHungrig", label: "üçΩÔ∏è Essen, wenn ich wirklich hungrig bin" },
  { id: "pauseMachen", label: "‚è∏Ô∏è Pause machen vor dem Essen" },
  { id: "richtigZubereiten", label: "üë©‚Äçüç≥ Richtiges Essen zubereiten" },
  { id: "nichtSnacken", label: "üôÖ‚Äç‚ôÄÔ∏è Nicht snacken beim Zubereiten" },
  { id: "einePortion", label: "ü•£ Eine Portion ‚Äì dann Schluss" },
];

const START_DATE = new Date(); // heute
const END_DATE = new Date(new Date().getFullYear(), 11, 31); // 31.12.

// ===== Utilities =====
const fmtDateKey = (d) => d.toISOString().slice(0, 10);

function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

function startOfWeek(d) {
  const date = new Date(d);
  const day = (date.getDay() + 6) % 7; // Mo=0
  date.setDate(date.getDate() - day);
  date.setHours(0,0,0,0);
  return date;
}

function endOfWeek(d) {
  const s = startOfWeek(d);
  const e = new Date(s);
  e.setDate(e.getDate() + 6);
  e.setHours(23,59,59,999);
  return e;
}

function rangeDays(a, b) {
  const out = [];
  const cur = new Date(a);
  cur.setHours(0,0,0,0);
  const last = new Date(b);
  last.setHours(0,0,0,0);
  while (cur <= last) {
    out.push(new Date(cur));
    cur.setDate(cur.getDate() + 1);
  }
  return out;
}

// ===== Storage Layer =====
const LS_KEY = "zieltracker_v1";

function useStorage() {
  const [state, setState] = useState(() => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch { return {}; }
  });

  useEffect(() => {
    try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch {}
  }, [state]);

  return [state, setState];
}

// ===== Main App =====
export default function App() {
  const today = new Date();
  const [store, setStore] = useStorage();
  const [activeDate, setActiveDate] = useState(fmtDateKey(today));
  const [view, setView] = useState("day"); // day | week | calendar

  // ensure active date within [START_DATE, END_DATE]
  useEffect(() => {
    const d = new Date(activeDate);
    if (d < START_DATE) setActiveDate(fmtDateKey(START_DATE));
    if (d > END_DATE) setActiveDate(fmtDateKey(END_DATE));
  }, [activeDate]);

  const dayData = store[activeDate] || {
    goals: Object.fromEntries(GOALS.map(g => [g.id, ""])), // "ja" | "nein" | "mehr"
    rating: 3,
    weightLoss: "unsicher", // ja | nein | unsicher
    notes: "",
  };

  function updateDay(patch) {
    setStore((s) => ({ ...s, [activeDate]: { ...dayData, ...patch } }));
  }

  const weekDays = useMemo(() => rangeDays(startOfWeek(new Date(activeDate)), endOfWeek(new Date(activeDate))), [activeDate]);

  // Weekly stats
  const weekly = useMemo(() => {
    const days = weekDays.map(d => fmtDateKey(d));
    return { days };
  }, [store, weekDays]);
    const records = days.map(k => store[k]).filter(Boolean);
    const goalHits = records.reduce((acc, r) => acc + Object.values(r.goals || {}).filter(Boolean).length, 0);
    const possible = records.length * GOALS.length;
    const completion = possible ? Math.round((goalHits / possible) * 100) : 0;
    const avgRating = records.length ? (records.reduce((a, r) => a + (r.rating || 0), 0) / records.length) : 0;
    const wlScore = records.reduce((a, r) => a + (r.weightLoss === "ja" ? 1 : r.weightLoss === "nein" ? -1 : 0), 0);
    const trend = wlScore > 0 ? "üìâ Abnahme wahrscheinlich" : wlScore < 0 ? "üìà Zunahme m√∂glich" : "‚ûñ neutral/unklar";
    return { completion, avgRating: Math.round(avgRating * 10) / 10, wlScore, trend, days };
  }, [store, weekDays]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-rose-50 via-amber-50 to-emerald-50 text-slate-800">
      <div className="mx-auto max-w-5xl p-6">
        <Header view={view} setView={setView} activeDate={activeDate} setActiveDate={setActiveDate} />
        {view === "day" && (
          <DayCard dateKey={activeDate} data={dayData} update={updateDay} />
        )}
        {view === "week" && (
          <WeekSummary activeDate={activeDate} weekly={weekly} weekDays={weekDays} store={store} />
        )}
        {view === "calendar" && (
          <CalendarView activeDate={activeDate} setActiveDate={setActiveDate} store={store} />
        )}
        <Footer />
      </div>
    </div>
  );
}

// ===== Components =====
function Header({ view, setView, activeDate, setActiveDate }) {
  const d = new Date(activeDate);
  const pretty = d.toLocaleDateString(undefined, { weekday: "long", year: "numeric", month: "long", day: "numeric" });

  function shift(days) {
    const nd = new Date(activeDate);
    nd.setDate(nd.getDate() + days);
    setActiveDate(fmtDateKey(nd));
  }

  return (
    <div className="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 className="text-2xl sm:text-3xl font-extrabold tracking-tight">Mein Ziel‚ÄëTracker bis Jahresende</h1>
        <p className="text-sm text-slate-600">{pretty}</p>
      </div>
      <div className="flex gap-2 items-center">
        <button onClick={() => setView("day")} className={`px-3 py-2 rounded-xl text-sm shadow ${view === "day" ? "bg-white" : "bg-white/60 hover:bg-white"}`}>Tag</button>
        <button onClick={() => setView("week")} className={`px-3 py-2 rounded-xl text-sm shadow ${view === "week" ? "bg-white" : "bg-white/60 hover:bg-white"}`}>Woche</button>
        <button onClick={() => setView("calendar")} className={`px-3 py-2 rounded-xl text-sm shadow ${view === "calendar" ? "bg-white" : "bg-white/60 hover:bg-white"}`}>Kalender</button>
        <div className="hidden sm:flex gap-1 ml-2">
          <IconButton onClick={() => shift(-1)} label="Vorheriger Tag">‚Üê</IconButton>
          <IconButton onClick={() => setActiveDate(fmtDateKey(new Date()))} label="Heute">‚óè</IconButton>
          <IconButton onClick={() => shift(1)} label="N√§chster Tag">‚Üí</IconButton>
        </div>
      </div>
    </div>
  );
}

function IconButton({ onClick, children, label }) {
  return (
    <button onClick={onClick} title={label} className="px-3 py-2 rounded-xl bg-white/70 hover:bg-white shadow">
      <span className="font-bold">{children}</span>
    </button>
  );
}

function Card({ children, className = "" }) {
  return (
    <div className={`rounded-2xl bg-white/80 backdrop-blur shadow-lg ring-1 ring-black/5 p-5 ${className}`}>
      {children}
    </div>
  );
}

function DayCard({ dateKey, data, update }) {
  const [openNotes, setOpenNotes] = useState(false);

  return (
    <div className="grid md:grid-cols-2 gap-6">
      <Card>
        <h2 className=\"text-xl font-bold mb-4\">üéØ Tagesziele</h2>
        <div className=\"flex flex-col gap-4\">
          {GOALS.map(g => (
            <div key={g.id} className=\"\">
              <div className=\"text-sm mb-2\">{g.label}</div>
              <div className=\"flex gap-2\">
                {[
                  { id: "ja", label: "Ja" },
                  { id: "nein", label: "Nein" },
                  { id: "mehr", label: "Mehr oder weniger" },
                ].map(o => (
                  <button
                    key={o.id}
                    onClick={() => update({ goals: { ...data.goals, [g.id]: o.id } })}
                    className={`px-3 py-1.5 rounded-xl text-sm shadow ${data.goals[g.id] === o.id ? "bg-emerald-100 ring-2 ring-emerald-300" : "bg-white"}`}
                  >{o.label}</button>
                ))}
              </div>
            </div>
          ))}
        </div>

      <div className="flex flex-col gap-6">
        <Card>
          <h2 className="text-xl font-bold mb-4">‚≠ê Tagesbewertung</h2>
          <div className="space-y-3">
            <div className="flex items-center gap-3">
              <span className="text-sm text-slate-600">Schlecht</span>
              <input
                type="range"
                min={1}
                max={5}
                value={data.rating}
                onChange={(e) => update({ rating: clamp(parseInt(e.target.value, 10), 1, 5) })}
                className="w-full"
              />
              <span className="text-sm text-slate-600">Top</span>
            </div>
            <div className="text-sm">Aktuell: <b>{data.rating} / 5</b></div>
          </div>
        </Card>

        <Card>
          <h2 className="text-xl font-bold mb-3">‚öñÔ∏è Tr√§gt dieser Tag zur Gewichtsabnahme bei?</h2>
          <div className="flex gap-2">
            {[
              { id: "ja", label: "Ja" },
              { id: "nein", label: "Nein" },
              { id: "unsicher", label: "Unsicher" },
            ].map(o => (
              <button key={o.id}
                onClick={() => update({ weightLoss: o.id })}
                className={`px-3 py-2 rounded-xl shadow ${data.weightLoss === o.id ? "bg-emerald-100 ring-2 ring-emerald-300" : "bg-white"}`}
              >{o.label}</button>
            ))}
          </div>
        </Card>

        <Card>
          <h2 className="text-lg font-semibold mb-2">üìù Notizen</h2>
          <textarea
            value={data.notes}
            onChange={(e) => update({ notes: e.target.value })}
            placeholder="Kurze Reflexion ‚Ä¶"
            className="w-full min-h-[90px] rounded-xl border border-slate-200 p-3 focus:outline-none focus:ring-2 focus:ring-amber-300"
          />
        </Card>
      </div>
    </div>
  );
}

function WeekSummary({ activeDate, weekly, weekDays, store }) {
  const cardRef = useRef(null);

  const title = (() => {
    const s = startOfWeek(new Date(activeDate));
    const e = endOfWeek(new Date(activeDate));
    const fmt = (d) => d.toLocaleDateString(undefined, { day: "2-digit", month: "2-digit" });
    return `${fmt(s)} ‚Äì ${fmt(e)}`;
  })();

  // Export helpers
  async function exportPNG() {
    try {
      const node = cardRef.current;
      const { toPng } = await import("html-to-image");
      const dataUrl = await toPng(node, { pixelRatio: 2, cacheBust: true, backgroundColor: "#ffffff" });
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = `wochenresume_${title.replace(/\s+/g, "_")}.png`;
      a.click();
    } catch (e) {
      alert("PNG-Export fehlgeschlagen. Versuche stattdessen CSV.");
    }
  }

  function exportCSV() {
    const headers = ["Datum", ...GOALS.map(g => g.label), "Bewertung(1-5)", "Gewichtsabnahme", "Notizen"];
    const rows = weekDays.map(d => {
      const k = fmtDateKey(d);
      const r = store[k] || {};
      const goalVals = GOALS.map(g => (r.goals?.[g.id] ? (r.goals[g.id] === 'ja' ? 'Ja' : r.goals[g.id] === 'nein' ? 'Nein' : 'Mehr oder weniger') : ''));
      return [k, ...goalVals, r.rating ?? "", r.weightLoss ?? "", (r.notes || "").replaceAll("
", " ")];
    });
      const r = store[k] || {};
      const goalVals = GOALS.map(g => (r.goals?.[g.id] ? "1" : "0"));
      return [k, ...goalVals, r.rating ?? "", r.weightLoss ?? "", (r.notes || "").replaceAll("\n", " ")];
    });
    const csv = [headers, ...rows].map(r => r.map(v => `"${String(v).replaceAll('"', '""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `woche_${title.replace(/\s+/g, "_")}.csv`; a.click();
    URL.revokeObjectURL(url);
  }

  // Markdown summary for copy-paste (e.g., in die Videobeschreibung)
  const md = useMemo(() => {
    const lines = [
      `# Wochen-Resume (${title})`,
      `
## Tage`,
      ...weekDays.map(d => {
        const k = fmtDateKey(d);
        const r = store[k] || {};
        const goals = GOALS.map(g => `${g.label.split(' ')[0]}: ${r.goals?.[g.id] ? (r.goals[g.id] === 'ja' ? 'Ja' : r.goals[g.id] === 'nein' ? 'Nein' : 'Mehr oder weniger') : '‚Äì'}`).join(' | ');
        const wl = r.weightLoss ? (r.weightLoss === 'ja' ? 'Ja' : r.weightLoss === 'nein' ? 'Nein' : 'Unsicher') : '‚Äì';
        const rating = r.rating ?? '‚Äì';
        return `- ${k}: ${goals} | Bewertung: ${rating}/5 | WL: ${wl}`;
      })
    ];
    return lines.join("
");
  }, [weekDays, store, title]);
        const r = store[k];
        const done = r ? Object.values(r.goals || {}).filter(Boolean).length : 0;
        const wl = r?.weightLoss ?? "‚Äì";
        const rating = r?.rating ?? "‚Äì";
        return `- ${k}: ${done}/${GOALS.length} Ziele | ${rating}/5 | WL: ${wl}`;
      })
    ];
    return lines.join("\n");
  }, [weekly, weekDays, store, title]);

  async function copyMD() {
    try {
      await navigator.clipboard.writeText(md);
      alert("Markdown in die Zwischenablage kopiert ‚úÖ");
    } catch { alert("Kopieren nicht m√∂glich ‚Äì bitte manuell markieren."); }
  }

  return (
    <div className="grid md:grid-cols-5 gap-6">
      <div className=\"md:col-span-3\">
        <Card className=\"relative\" >
          <div ref={cardRef} className=\"space-y-4\">
            <h2 className=\"text-xl font-bold\">üìÜ Wochen√ºbersicht {title}</h2>
            <div className=\"overflow-auto\">
              <table className=\"min-w-full text-sm\">
                <thead>
                  <tr className=\"text-left text-slate-600\">
                    <th className=\"py-2 pr-3\">Datum</th>
                    {GOALS.map(g => (
                      <th key={g.id} className=\"py-2 pr-3\">{g.label}</th>
                    ))}
                    <th className=\"py-2 pr-3\">Tagesbewertung</th>
                    <th className=\"py-2 pr-3\">Gewichtsabnahme</th>
                  </tr>
                </thead>
                <tbody>
                  {weekDays.map(d => {
                    const k = fmtDateKey(d);
                    const r = store[k] || {};
                    return (
                      <tr key={k} className=\"border-t border-slate-200\">
                        <td className=\"py-2 pr-3 whitespace-nowrap\">{k}</td>
                        {GOALS.map(g => (
                          <td key={g.id} className=\"py-2 pr-3\">
                            <span className=\"inline-block px-2 py-1 rounded-lg bg-white ring-1 ring-slate-200\">{r.goals?.[g.id] ? (r.goals[g.id] === 'ja' ? 'Ja' : r.goals[g.id] === 'nein' ? 'Nein' : 'Mehr oder weniger') : '‚Äì'}</span>
                          </td>
                        ))}
                        <td className=\"py-2 pr-3\">
                          <span className=\"inline-block px-2 py-1 rounded-lg bg-white ring-1 ring-slate-200\">{r.rating ?? '‚Äì'}</span>
                        </td>
                        <td className=\"py-2 pr-3\">
                          <span className=\"inline-block px-2 py-1 rounded-lg bg-white ring-1 ring-slate-200\">{r.weightLoss ? (r.weightLoss === 'ja' ? 'Ja' : r.weightLoss === 'nein' ? 'Nein' : 'Unsicher') : '‚Äì'}</span>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
          <div className=\"mt-4 flex gap-2\">
            <button onClick={exportPNG} className=\"px-3 py-2 rounded-xl bg-emerald-100 hover:bg-emerald-200 shadow\">PNG exportieren</button>
            <button onClick={exportCSV} className=\"px-3 py-2 rounded-xl bg-amber-100 hover:bg-amber-200 shadow\">CSV exportieren</button>
            <button onClick={copyMD} className=\"px-3 py-2 rounded-xl bg-sky-100 hover:bg-sky-200 shadow\">Markdown kopieren</button>
          </div>
        </Card>
      </div>

      <div className=\"md:col-span-2\">
        <Card>
          <h3 className=\"font-semibold mb-2\">Hinweis</h3>
          <p className=\"text-sm text-slate-600\">In der Wochen√ºbersicht stehen <b>nur W√∂rter in K√§stchen</b> ‚Äì keine zus√§tzlichen Zahlen oder Symbole. Nutze die Tagesansicht zum Ausf√ºllen.</p>
        </Card>
      </div>
    </div>
  );
}

function Stat({ label, value, sub }) {
  return (
    <div className="rounded-2xl p-4 bg-gradient-to-br from-white to-white/60 ring-1 ring-black/5 shadow">
      <div className="text-xs uppercase tracking-wide text-slate-500">{label}</div>
      <div className="text-2xl font-extrabold mt-1">{value}</div>
      {sub && <div className="text-xs text-slate-500 mt-1">{sub}</div>}
    </div>
  );
}

function CalendarView({ activeDate, setActiveDate, store }) {
  const first = startOfWeek(START_DATE);
  const last = endOfWeek(END_DATE);
  const days = rangeDays(first, last);

  function scoreFor(k) {
    const r = store[k];
    if (!r) return 0;
    const goals = Object.values(r.goals || {}).filter(Boolean).length;
    const rating = r.rating || 0;
    const wl = r.weightLoss === "ja" ? 1 : r.weightLoss === "nein" ? -1 : 0;
    return goals + rating + wl; // simple heat score
  }

  return (
    <Card>
      <h2 className="text-xl font-bold mb-4">Kalender (bis 31.12.)</h2>
      <div className="grid grid-cols-7 gap-1">
        {days.map((d, i) => {
          const k = fmtDateKey(d);
          const s = scoreFor(k);
          const hue = 120; // green hue
          const light = 95 - Math.min(80, s * 8);
          const bg = `hsl(${hue} 70% ${light}%)`;
          const isActive = k === activeDate;
          return (
            <button
              key={k}
              data-date={k}
              onClick={() => setActiveDate(k)}
              className={`aspect-square rounded-xl text-[10px] sm:text-xs p-1 border ${isActive ? "border-emerald-500" : "border-transparent"}`}
              style={{ background: bg }}
              title={k}
            >
              <div className="font-semibold">{d.getDate()}</div>
              <div className="opacity-70">{s ? `${s}` : "‚Äì"}</div>
            </button>
          );
        })}
      </div>
      <p className="text-xs text-slate-500 mt-2">Farbgebung zeigt Aktivit√§t/Erfolg (dunkler = mehr Erf√ºllung).</p>
    </Card>
  );
}

function Footer() {
  return (
    <div className="mt-8 text-center text-xs text-slate-500">
      Lokal gespeichert (üö´ keine Cloud). ‚Äì Exportiere jede Woche dein Resume als PNG/CSV.
    </div>
  );
}
